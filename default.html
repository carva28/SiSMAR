<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
        integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>
    <style>
        h2 {
            text-align: center;
        }

        #issMap {
            height: 560px;
        }

        .leaflet-interactive {
            /* stroke: #00ff6a; */
            opacity: 0.6;
        }

        .leaflet-marker-icon {
            opacity: 1;
        }

        .btn {
            text-align: center;
            margin: auto;
            display: block;
            margin-bottom: 20px;
        }

        h4 {
            text-align: center;
            margin-bottom: 20px;
        }

        #calado_span {
            text-align: center;
        }

        #time {
            margin: auto;
            display: block;
            margin-bottom: 20px;
            padding: 5px;
            text-align: center;
            font-size: 30px;
            border: 2px solid #ffc10a;
            border-radius: 20px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>

    <title>SiSMAR</title>
</head>

<body>
    <h2>Mapa</h2>

    <div class="container">
        <div class="row">
            <div class="col">
                <p>
                    latitude: <span id="lat"></span><br />
                    longitude: <span id="lng"></span>
                </p>
            </div>
            <div class="col order-12">
                <div id="clockbox"></div>

            </div>
            <div class="col order-1">
                <p>Calado<input type="text" id="calado_span" /> metro(s)</p>
                <button type="button" class="btn btn-primary" onclick="changeValue()">Alterar</button>
            </div>
        </div>
        <h4>Escolha uma rota</h4>
        <div class="row">

            <div class="col">
                <button type="button" class="btn btn-warning" onclick="rota('r2')">Rota 2</button>
            </div>
            <div class="col">
                <button type="button" class="btn btn-danger" onclick="clearmap()">Apagar</button>

            </div>
        </div>
        <div class="row">

            <div class="col">
                <input type="time" id="time" />
                <button type="button" class="btn btn-warning" onclick="calculo()">Escolher Hora</button>
            </div>

        </div>
    </div>
    </div>
    <div id="issMap"></div>

    <script>
        // Making a map and tiles
        const mymap = L.map('issMap').setView([40.71, -8.68177413], 12);
        const attribution =
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

        const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const tiles = L.tileLayer(tileUrl, { attribution });
        tiles.addTo(mymap);

        // Making a marker with a custom icon
        const issIcon = L.icon({
            iconUrl: 'marker.png',
            iconSize: [22, 32, 5],
            iconAnchor: [10, 30],
        });
        let marker = L.marker([40.727291289709356, -8.652763366699219], { icon: issIcon }).addTo(mymap).on('click', onClick);
        mymap.on('zoomend', function () {
            const zoom = mymap.getZoom() + 1;
            // const w = 11 * zoom;
            // const h = 16 * zoom;
            // issIcon.options.iconSize = [44, 65];
            // issIcon.options.iconAnchor = [w / 2, h / 2];
            mymap.removeLayer(marker);
            let latlng = marker.getLatLng();
            marker = L.marker([40.727291289709356, -8.652763366699219], { icon: issIcon }).addTo(mymap).on('click', onClick);;
            marker.setLatLng(latlng);
        });

        var linesFeatureLayer
        function onClick(e) {
            console.log(e.latlng);
            console.log(e.latlng.lat);
            console.log(e.latlng.lng);
            document.getElementById('lat').innerHTML = "<p>" + e.latlng.lat + "</p>";
            document.getElementById('lng').innerHTML = "<p>" + e.latlng.lng + "</p>";
            if (e.latlng.lat == 40.727291289709356 && e.latlng.lng == -8.652763366699219) {
                mymap.eachLayer(function (layer) {
                    //console.log(layer)
                    console.log(layer.options.pane)
                    if (layer.options.pane == "overlayPane") {
                        mymap.removeLayer(layer);
                    }

                });
                var valorInput = document.getElementById('calado_span').value;

                if (valorInput != "") {
                    calculo(valorInput);
                } else {
                    calculo(1);
                }

            }
        }
    </script>


    <script type="text/javascript">
        var calado = 1;
        tday = new Array("Domingo", "Segunda-Feira",
            "Terça-Feira", "Quarta-Feira",
            "Quinta-Feira", "Sexta-Feira", "Sábado");
        tmonth = new Array("Janeiro", "Fevereiro", "Março",
            "Abril", "Maio", "Junho", "Julho",
            "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro");

        function GetClock() {
            var d = new Date();
            var nday = d.getDay(), nmonth = d.getMonth(),
                ndate = d.getDate(), nyear = d.getYear(),
                nhour = d.getHours(), nmin = d.getMinutes(), nsec = d.getSeconds(), ap;

            if (nhour == 0) { ap = " AM"; nhour = 12; }
            else if (nhour < 12) { ap = " AM"; }
            else if (nhour == 12) { ap = " PM"; }
            else if (nhour > 12) { ap = " PM"; nhour -= 12; }

            if (nyear < 1000) nyear += 1900;
            if (nmin <= 9) nmin = "0" + nmin;
            if (nsec <= 9) nsec = "0" + nsec;

            document.getElementById('clockbox').innerHTML = "" + tday[nday] + ", " + tmonth[nmonth] + " " + ndate + ", " + nyear + " " + nhour + ":" + nmin + ":" + nsec + ap + "";
        }

        window.onload = function () {
            GetClock();
            setInterval(GetClock, 1000);
        }

        var arrayhidrografico = [];

        async function getInfo() {

            // const proxyurl = "https://cors-anywhere.herokuapp.com/";
            // const url = 'https://www.hidrografico.pt/json/mare.graph.val.php?po=13&dd=2020-02-03&nd=0';
            // fetch(url)
            //     .then(response => response.json())
            //     .then(json => console.log(json))
            // const response = await fetch('https://www.hidrografico.pt/json/mare.graph.val.php?po=13&dd=2020-02-03&nd=0');
            // if (response.ok) { 
            //     let json = await response.json();
            // } else {
            //     alert("HTTP-Error: " + response.status);
            // }


            var d = new Date();
            var nday = d.getDay(),
                nmonth = d.getMonth(),
                ndate = d.getDate(),
                nyear = d.getYear();
            if (nyear < 1000) nyear += 1900;
            console.log(nyear, nmonth + 1, ndate);
            let mescerto = nmonth + 1;

            const proxyurl = "https://cors-anywhere.herokuapp.com/";
            const url = 'https://www.hidrografico.pt/json/mare.graph.val.php?po=13&dd=' + nyear + '-' + mescerto + '-' + ndate + '&nd=0'; // site that doesn’t send Access-Control-*
            fetch(proxyurl + url) // https://cors-anywhere.herokuapp.com/https://example.com
                .then(response => response.json())
                .then(contents => arrayhidrografico.push(contents))
                .catch(() => console.log("Can’t access " + url + " response. Blocked by browser?"))
        }

        getInfo();



        //Realiza o calculo com base no excel
        function calculo() {
            //remover a rota realizada e atualizar
            mymap.eachLayer(function (layer) {
                //console.log(layer.options.pane)
                if (layer.options.pane == "overlayPane") {
                    mymap.removeLayer(layer);
                }
            });
            var valorInput = document.getElementById('calado_span').value;
            if (valorInput != "") {
                calado = valorInput
            } else {
                calado = 1;
            }
            var tempo = document.getElementById('time').value;
            let UserHoras;
            if (tempo != "") {
                var d = new Date();
                var nday = d.getDay(),
                    nmonth = d.getMonth() + 1,
                    ndate = d.getDate(),
                    nyear = d.getYear();
                if (nyear < 1000) nyear += 1900;
                var splitTime1 = tempo.split(':');
                UserHoras = new Date(nyear, nmonth, nday, splitTime1[0], splitTime1[1]);
            } else {
                var d = new Date();
                var nday = d.getDay(),
                    nmonth = d.getMonth(),
                    ndate = d.getDate(),
                    nyear = d.getYear();
                if (nyear < 1000) nyear += 1900;
                let hora = "20";
                let min = "00";

                UserHoras = new Date(nyear, nmonth, nday, hora, min);
            }

            var guardarHoras = [];
            let sortedData;
            if (arrayhidrografico.length > 0) {


                for (let i = 0; i < arrayhidrografico.length; i++) {
                    let UserHorasMin = UserHoras.getHours() + ":" + UserHoras.getMinutes();
                    let datefrente;
                    console.log(arrayhidrografico[i])
                    for (let j = 0; j < arrayhidrografico[i].length; j++) {
                        let date = new Date(arrayhidrografico[i][j].SDATA);
                        let horatempoAPI = date.getHours() + ":" + date.getMinutes();
                        guardarHoras.push(arrayhidrografico[i][j])

                    }

                    sortedData = guardarHoras.sort((a, b) => new Date(a.SDATA) - new Date(b.SDATA))

                }

                var arrayMares = [];
                var mareUser = [];
                for (let k = 0; k < sortedData.length; k++) {

                    let date = new Date(sortedData[k].SDATA);
                    let dataSDATA = date.getHours() + ":" + date.getMinutes();

                    if (sortedData[k + 1] != undefined) {
                        datefrente = new Date(sortedData[k + 1].SDATA);
                    } else {
                        console.log('')
                    }


                    arrayMares.push(sortedData[k].ALT)
                    let dataSDATAFrente = datefrente.getHours() + ":" + datefrente.getMinutes();

                    if (sortedData[k] == sortedData[0]) {
                        if (UserHoras.getHours() <= date.getHours()) {

                            mareUser.push(sortedData[k].ALT)
                        }
                    } else if (UserHoras.getHours() >= date.getHours() && UserHoras.getHours() < datefrente.getHours()) {

                        mareUser.push(sortedData[k].ALT)
                    } else if (sortedData[k] == sortedData[3]) {
                        if (UserHoras.getHours() >= date.getHours()) {
                            mareUser.push(sortedData[k].ALT)

                        }
                    }
                }


                var arRetirMare = [];
                let count = 0, mare_max, mare_min, variacaomare, variaca;
                let soma = 0, somamare2 = 0;
                for (let p = 0; p < arrayMares.length; p++) {

                    mare_max = Math.max(...arrayMares);
                    mare_min = Math.min(...arrayMares);

                    variaca = mare_max - mare_min;
                    variacaomare = variaca.toFixed(2)

                    if (arRetirMare.length == 0) {
                        arRetirMare.push(mareUser[0]);
                        count++;
                    } else {
                        if (mareUser[0] == arrayMares[p]) {
                            for (let a = 0; a < 15; a++) {

                                soma = arRetirMare[a] + 1 / (12 * variacaomare);
                                let doisdsoma = soma;
                                arRetirMare.push(doisdsoma);
                            }
                        }
                    }
                }
            }
            console.log(arRetirMare)

            //calado = var_cal;
            var margemcaladoSup, margemcaladoInf;
            var velocidademedia = 5;
            var diferençaTempo, ZNOvaRota, verificarRota;
            var linesFeatureLayer, linesFeatureLayer2, linesFeatureLayer3;
            margemcaladoSup = 0.2;
            margemcaladoInf = 0.1;


            var coordenadas = [
                [-8.762712478637695, 40.64196329226261],
                [-8.752756118774414, 40.644828856258954],
                [-8.742284774780273, 40.64593597303585],
                [-8.73464584350586, 40.65016889724004],
                [-8.727693557739258, 40.655703854536746],
                [-8.725204467773438, 40.66117324360654],
                [-8.72288703918457, 40.66826975856376],
                [-8.716878890991211, 40.675495708799446],
                [-8.715934753417969, 40.68363210267408],
                [-8.717050552368164, 40.692548449646836],
                [-8.714303970336914, 40.702569780377935],
                [-8.707437515258789, 40.71102817184792],
                [-8.696279525756834, 40.71642796756138],
                [-8.681774139404297, 40.72104672237615],
                [-8.667354583740234, 40.72481955186487],
                [-8.652763366699219, 40.727291289709356],
            ];

            // var baixamar = 0.3;
            // var preiamar = 3;
            // var variacaomare = preiamar - baixamar;
            // var intervalosTempo = "00:15";
            //var splitTime1 = tempo.split(':');
            // var splitTime2 = intervalosTempo.split(':');
            // // var hoursMinutes = tempo.split(/[.:]/);
            // var tempototal = parseInt(splitTime1[1]) + parseInt(splitTime2[1]);

            // minute = tempototal % 60;
            // var horastotal = splitTime1[0] + ':' + minute;

            // var quarterHours = ["00", "15", "30", "45"];
            // var times = [];
            // var mares = [];
            // var horas_mares = [];
            // var mares_entre_pontos_altos = [];
            // var cont = 1;
            // var cont2 = 1;
            // var mares_restantes = [];
            // for (var i = 0; i < 24; i++) {
            //     for (var j = 0; j < 4; j++) {
            //         if ((i >= 13 && i < 19 && quarterHours[j] == 30) || (i >= 1 && i < 7 && quarterHours[j] == 30)
            //             || (i >= 0 && i < 7 && quarterHours[j] == 30) || (i >= 23 && quarterHours[j] == 30)) {
            //             mares.push(((preiamar - cont) / 12) * variacaomare)
            //             horas_mares.push(i + ":" + quarterHours[j]);
            //             cont++;

            //         } else if ((i >= 19 && i < 23 && quarterHours[j] == 30) || (i >= 7 && i < 13 && quarterHours[j] == 30)) {
            //             mares.push(((baixamar + cont) / 12) * variacaomare)
            //             horas_mares.push(i + ":" + quarterHours[j]);
            //             cont2++;
            //         }
            //     }
            // }

            // console.log(mares)
            // console.log(horas_mares)

            var nivel_mare = [
                [3],
                [2.94375],
                [2.8875],
                [2.83125],
                [2.775],
                [2.6625],
                [2.55],
                [2.4375],
                [2.325],
                [2.15625],
                [1.9875],
                [1.81875],
                [1.65],
                [1.48125],
                [1.31],
                [1.14],
            ];

            var nivel_ZRotaAdquirida = [
                [3.5],
                [3.30],
                [3.4],
                [3.4],
                [3.70],
                [4],
                [4.5],
                [3],
                [3.4],
                [4],
                [3.9],
                [3.20],
                [3.0],
                [3.4],
                [3.5],
                [3],
            ];

            // var nivel_mareNOVA = [
            //     [0.41],
            //     [0.3],
            //     [0.36],
            //     [0.41],
            //     [0.53],
            //     [0.6375],
            //     [0.75],
            //     [0.8625],
            //     [0.975],
            //     [1.14375],
            //     [1.3125],
            //     [1.48125],
            //     [1.65],
            //     [1.82],
            //     [1.99],
            //     [2.16],
            // ];

            document.getElementById('calado_span').value = calado;
            for (var i = 0; i < coordenadas.length; i++) {
                console.log(arRetirMare[i]);
                //diferençaAlturaMare = nivel_mare[i][0] - nivel_mareNOVA[i][0];
                diferençaAlturaMare = nivel_mare[i][0] - arRetirMare[i];
                ZNOvaRota = nivel_ZRotaAdquirida[i][0] - diferençaAlturaMare;
                verificarRota = ZNOvaRota - calado;
                //console.log(verificarRota)
                if (verificarRota < margemcaladoInf) {

                    if (coordenadas[i + 1] != undefined) {


                        //console.log('vermelho' + verificarRota)
                        var myLines1 = [{
                            "type": "LineString",
                            'coordinates': [
                                [coordenadas[i][0], coordenadas[i][1]],
                                [coordenadas[i + 1][0], coordenadas[i + 1][1]],
                            ]
                        }];

                        var myStyle1 = {
                            radius: 8,
                            color: "red",
                            weight: 5,
                            opacity: 1,
                        };

                        linesFeatureLayer = L.geoJson(myLines1, {
                            style: myStyle1
                        });
                        linesFeatureLayer.addTo(mymap);
                    } else {
                        console.log('t')
                    }
                } else if (verificarRota >= margemcaladoInf && verificarRota <= margemcaladoSup) {

                    if (coordenadas[i + 1] != undefined) {
                        //console.log('amarelo' + verificarRota)
                        var myLines2 = [{
                            "type": "LineString",
                            'coordinates': [
                                [coordenadas[i][0], coordenadas[i][1]],
                                [coordenadas[i + 1][0], coordenadas[i + 1][1]],
                            ]
                        }];

                        var myStyle2 = {
                            radius: 8,
                            color: "yellow",
                            weight: 5,
                            opacity: 1,
                        };

                        linesFeatureLayer2 = L.geoJson(myLines2, {
                            style: myStyle2
                        });
                        linesFeatureLayer2.addTo(mymap);
                    } else {
                        console.log('t')
                    }
                } else if (verificarRota >= margemcaladoSup) {

                    if (coordenadas[i + 1] != undefined) {
                        //console.log('verde' + verificarRota)
                        var myLines3 = [{
                            "type": "LineString",
                            'coordinates': [
                                [coordenadas[i][0], coordenadas[i][1]],
                                [coordenadas[i + 1][0], coordenadas[i + 1][1]],
                            ]
                        }];

                        var myStyle3 = {
                            radius: 8,
                            color: "green",
                            weight: 5,
                            opacity: 1,
                        };

                        linesFeatureLayer3 = L.geoJson(myLines3, {
                            style: myStyle3
                        });
                        linesFeatureLayer3.addTo(mymap);
                    } else {
                        console.log('')
                    }
                }

            }

        }





        function clearmap() {

            mymap.eachLayer(function (layer) {
                //console.log(layer.options.pane)
                if (layer.options.pane == "overlayPane") {
                    mymap.removeLayer(layer);
                }
            });
        }
    </script>

</body>

</html>