<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
        integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>
    <style>
        h2 {
            text-align: center;
        }

        #issMap {
            height: 560px;
        }

        .leaflet-interactive {
            /* stroke: #00ff6a; */
            opacity: 0.6;
        }

        .leaflet-marker-icon {
            opacity: 1;
        }

        .btn {
            text-align: center;
            margin: auto;
            display: block;
            margin-bottom: 20px;
        }

        h4 {
            text-align: center;
            margin-bottom: 20px;
        }

        #calado_span,
        #calado_sup_span,
        #calado_inf_span {
            margin: auto;
            display: block;
            margin-bottom: 20px;
            padding: 5px;
            text-align: center;
            font-size: 30px;
            border: 2px solid #ffc10a;
            border-radius: 20px;
            width: 150px;
        }

        #time {
            margin: auto;
            display: block;
            margin-bottom: 20px;
            padding: 5px;
            text-align: center;
            font-size: 30px;
            border: 2px solid #ffc10a;
            border-radius: 20px;
            width: 150px;
        }

        .row,
        .col p {
            text-align: center;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>

    <title>SiSMAR</title>
</head>

<body>
    <h2>Mapa</h2>

    <div class="container">
        <div class="row">
            <div class="col">
                <div id="km"></div>
                <!-- <p>
                    latitude: <span id="lat"></span><br />
                    longitude: <span id="lng"></span>
                </p> -->

            </div>
            <div class="col order-12">
                <div id="clockbox"></div>
            </div>

        </div>
        <h4>Simule uma rota</h4>
        <div class="row">

            <div class="col">
                <p>Calado metro(s)</p>
                <input type="number" id="calado_span" />
            </div>
            <div class="col">
                <p>Limite Superior metro(s)</p>
                <input type="number" id="calado_sup_span" />
            </div>
            <div class="col">
                <p>Limite Inferior metro(s)</p>
                <input type="number" id="calado_inf_span" />
            </div>
            <div class="col">
                <p>TTD</p>
                <input type="time" id="time" />
            </div>

        </div>
    </div>
    <div class="row">
        <div class="col">
            <button type="button" class="btn btn-warning" onclick="changeValue()">Simular</button>
        </div>
        <div class="col">
            <button type="button" class="btn btn-danger" onclick="clearmap()">Apagar</button>
        </div>

    </div>
    </div>
    </div>
    <div id="issMap"></div>

    <script>
        // Making a map and tiles
        const mymap = L.map('issMap').setView([40.71, -8.68177413], 12);
        const attribution =
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

        const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const tiles = L.tileLayer(tileUrl, { attribution });
        tiles.addTo(mymap);

        // Making a marker with a custom icon
        const issIcon = L.icon({
            iconUrl: 'marker.png',
            iconSize: [22, 32, 5],
            iconAnchor: [10, 30],
        });
        let marker = L.marker([40.727291289709356, -8.652763366699219], { icon: issIcon }).addTo(mymap).on('click', onClick);
        mymap.on('zoomend', function () {
            const zoom = mymap.getZoom() + 1;
            // const w = 11 * zoom;
            // const h = 16 * zoom;
            // issIcon.options.iconSize = [44, 65];
            // issIcon.options.iconAnchor = [w / 2, h / 2];
            mymap.removeLayer(marker);
            let latlng = marker.getLatLng();
            marker = L.marker([40.727291289709356, -8.652763366699219], { icon: issIcon }).addTo(mymap).on('click', onClick);;
            marker.setLatLng(latlng);
        });

        L.control.scale().addTo(mymap);

        //Localização do Utilizador
        mymap.locate({ setView: true, maxZoom: 16 });
        function onLocationFound(e) {
            var radius = e.accuracy;

            L.marker(e.latlng).addTo(mymap)
                .bindPopup("You are within " + radius + " meters from this point").openPopup();

            L.circle(e.latlng, radius).addTo(mymap);
        }

        mymap.on('locationfound', onLocationFound);

        //No clique do marker

        var linesFeatureLayer
        function onClick(e) {
            // console.log(e.latlng);
            // console.log(e.latlng.lat);
            // console.log(e.latlng.lng);
            // document.getElementById('lat').innerHTML = "<p>" + e.latlng.lat + "</p>";
            // document.getElementById('lng').innerHTML = "<p>" + e.latlng.lng + "</p>";
            if (e.latlng.lat == 40.727291289709356 && e.latlng.lng == -8.652763366699219) {
                mymap.eachLayer(function (layer) {
                    //console.log(layer)
                    //console.log(layer.options.pane)
                    if (layer.options.pane == "overlayPane") {
                        mymap.removeLayer(layer);
                    }
                });
                var valorInput = document.getElementById('calado_span').value;
                var valorInput2 = document.getElementById('calado_sup_span').value;
                var valorInput3 = document.getElementById('calado_inf_span').value;
                if (valorInput != "" && valorInput2 != "" && valorInput3 != "") {
                    calculo(valorInput, valorInput2, valorInput3);
                } else {
                    calado = 1;
                    margemcaladoSup = 0.2;
                    margemcaladoInf = 0.1;
                    calculo(1, 0.2, 0.1);
                }

            }
        }
    </script>


    <script type="text/javascript">
        var calado = 1;
        tday = new Array("Domingo", "Segunda-Feira",
            "Terça-Feira", "Quarta-Feira",
            "Quinta-Feira", "Sexta-Feira", "Sábado");
        tmonth = new Array("Janeiro", "Fevereiro", "Março",
            "Abril", "Maio", "Junho", "Julho",
            "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro");

        function GetClock() {
            var d = new Date();
            var nday = d.getDay(), nmonth = d.getMonth(),
                ndate = d.getDate(), nyear = d.getYear(),
                nhour = d.getHours(), nmin = d.getMinutes(), nsec = d.getSeconds(), ap;

            if (nhour == 0) { ap = " AM"; nhour = 12; }
            else if (nhour < 12) { ap = " AM"; }
            else if (nhour == 12) { ap = " PM"; }
            else if (nhour > 12) { ap = " PM"; nhour -= 12; }

            if (nyear < 1000) nyear += 1900;
            if (nmin <= 9) nmin = "0" + nmin;
            if (nsec <= 9) nsec = "0" + nsec;

            document.getElementById('clockbox').innerHTML = "" + tday[nday] + ", " + tmonth[nmonth] + " " + ndate + ", " + nyear + " " + nhour + ":" + nmin + ":" + nsec + ap + "";
        }

        window.onload = function () {
            GetClock();
            setInterval(GetClock, 1000);
        }

        var arrayhidrografico = [];

        async function getInfo() {
            var d = new Date();
            var nday = d.getDay(),
                nmonth = d.getMonth(),
                ndate = d.getDate(),
                nyear = d.getYear();
            if (nyear < 1000) nyear += 1900;
            console.log(nyear, nmonth + 1, ndate);
            let mescerto = nmonth + 1;

            const proxyurl = "https://cors-anywhere.herokuapp.com/";
            const url = 'https://www.hidrografico.pt/json/mare.graph.val.php?po=13&dd=' + nyear + '-' + mescerto + '-' + ndate + '&nd=0'; // site that doesn’t send Access-Control-*
            fetch(proxyurl + url) // https://cors-anywhere.herokuapp.com/https://example.com
                .then(response => response.json())
                .then(contents => arrayhidrografico.push(contents))
                .catch(() => console.log("Can’t access " + url + " response. Blocked by browser?"))
        }

        getInfo();

        function changeValue(e) {
            var valorInput = document.getElementById('calado_span').value;
            var valorInput2 = document.getElementById('calado_sup_span').value;
            var valorInput3 = document.getElementById('calado_inf_span').value;
            if (valorInput != "" && valorInput2 != "" && valorInput3 != "") {
                calculo(valorInput, valorInput2, valorInput3);
            } else {
                calado = 1;
                margemcaladoSup = 0.2;
                margemcaladoInf = 0.1;
                calculo(1, 0.2, 0.1);
            }
        }


        //Realiza o calculo com base no excel
        function calculo(valor_cal, cal_sup, cal_inf) {
            //remover a rota realizada e atualizar
            mymap.eachLayer(function (layer) {
                //console.log(layer.options.pane)
                if (layer.options.pane == "overlayPane") {
                    mymap.removeLayer(layer);
                }
            });
            document.getElementById('calado_span').value = valor_cal;
            document.getElementById('calado_sup_span').value = cal_sup;
            document.getElementById('calado_inf_span').value = cal_inf;

            //atribuir um calado à rota
            var valorInput = document.getElementById('calado_span').value;
            if (valorInput != "") {
                calado = valorInput
            } else {
                calado = 1;
            }
            //selecionar um tempo HH:MM
            var tempo = document.getElementById('time').value;
            let UserHoras;
            if (tempo != "") {
                var d = new Date();
                var nday = d.getDay(),
                    nmonth = d.getMonth() + 1,
                    ndate = d.getDate(),
                    nyear = d.getYear();
                if (nyear < 1000) nyear += 1900;
                var splitTime1 = tempo.split(':');
                UserHoras = new Date(nyear, nmonth, nday, splitTime1[0], splitTime1[1]);
            } else {
                var d = new Date();
                var nday = d.getDay(),
                    nmonth = d.getMonth(),
                    ndate = d.getDate(),
                    nyear = d.getYear();
                if (nyear < 1000) nyear += 1900;
                nhour = d.getHours(), nmin = d.getMinutes();
                // let hora = "20";
                // let min = "00";
                UserHoras = new Date(nyear, nmonth, nday, nhour, nmin);
                var now = new Date(Date.now());
                var f = leadZero(now.getHours()) + ":" + leadZero(now.getMinutes());
                console.log(f)
                document.getElementById('time').value = f;
            }

            function leadZero(_something) {
                if (parseInt(_something) < 10) return "0" + _something;
                return _something;//else    
            }

            var guardarHoras = [];
            let sortedData;
            var arRetirMare = [];
            let count = 0, mare_max, mare_min, variacaomare, variaca;
            let soma = 0, somamare2 = 0;
            var arrayMares = [];
            var mareUser = [];
            if (arrayhidrografico.length > 0) {


                for (let i = 0; i < arrayhidrografico.length; i++) {
                    let UserHorasMin = UserHoras.getHours() + ":" + UserHoras.getMinutes();
                    let datefrente;
                    for (let j = 0; j < arrayhidrografico[i].length; j++) {

                        let date = new Date(arrayhidrografico[i][j].SDATA);
                        let horatempoAPI = date.getHours() + ":" + date.getMinutes();
                        guardarHoras.push(arrayhidrografico[i][j])

                    }
                    sortedData = guardarHoras.sort((a, b) => new Date(a.SDATA) - new Date(b.SDATA))
                }


                for (let k = 0; k < sortedData.length; k++) {

                    let date = new Date(sortedData[k].SDATA);
                    let dataSDATA = date.getHours() + ":" + date.getMinutes();

                    if (sortedData[k + 1] != undefined) {
                        datefrente = new Date(sortedData[k + 1].SDATA);
                    } else {

                    }


                    arrayMares.push(sortedData[k].ALT)
                    let dataSDATAFrente = datefrente.getHours() + ":" + datefrente.getMinutes();

                    if (sortedData[k] == sortedData[0]) {
                        if (UserHoras.getHours() <= date.getHours()) {
                            mareUser.push(sortedData[k].ALT)
                        }
                    } else if (sortedData[k] == sortedData[1]) {
                        dateatras = new Date(sortedData[k - 1].SDATA);
                        if (UserHoras.getHours() > dateatras.getHours() && UserHoras.getHours() <= date.getHours()) {
                            mareUser.push(sortedData[k].ALT)
                        }
                    } else if (sortedData[k] == sortedData[2]) {
                        dateatras2 = new Date(sortedData[k - 1].SDATA);
                        if (UserHoras.getHours() > dateatras2.getHours() && UserHoras.getHours() <= date.getHours()) {
                            mareUser.push(sortedData[k].ALT)
                        }
                    } else if (sortedData[k] == sortedData[3]) {
                        dateatras2 = new Date(sortedData[k - 1].SDATA);

                        if (UserHoras.getHours() > dateatras2.getHours() && UserHoras.getHours() <= date.getHours()) {
                            mareUser.push(sortedData[k].ALT)
                        } else if (UserHoras.getHours() >= date.getHours()) {
                            mareUser.push(sortedData[k].ALT)
                        }
                    }
                }

                for (let p = 0; p < arrayMares.length; p++) {

                    mare_max = Math.max(...arrayMares);
                    mare_min = Math.min(...arrayMares);

                    variaca = mare_max - mare_min;
                    variacaomare = variaca.toFixed(2)

                    if (arRetirMare.length == 0) {
                        arRetirMare.push(mareUser[0]);
                    } else {
                        if (mareUser[0] == arrayMares[p]) {
                            for (let a = 0; a < 15; a++) {
                                soma = arRetirMare[a] + 1 / (12 * variacaomare);
                                let doisdsoma = soma;
                                arRetirMare.push(doisdsoma);
                            }
                        } else if (mareUser[0] == arrayMares[p - 1] || mareUser[0] == arrayMares[2]) {
                            for (let a = 0; a < 15; a++) {
                                soma = arRetirMare[a] - 1 / (12 * variacaomare);
                                let doisdsoma = soma;
                                arRetirMare.push(doisdsoma);
                            }
                        }
                    }
                }
            }

            var margemcaladoSup, margemcaladoInf;
            var velocidademedia = 5;
            var diferençaTempo, ZNOvaRota, verificarRota;
            var linesFeatureLayer, linesFeatureLayer2, linesFeatureLayer3;
            margemcaladoSup = cal_sup;
            margemcaladoInf = cal_inf;


            var coordenadas = [
                [-8.762712478637695, 40.64196329226261],
                [-8.752756118774414, 40.644828856258954],
                [-8.742284774780273, 40.64593597303585],
                [-8.73464584350586, 40.65016889724004],
                [-8.727693557739258, 40.655703854536746],
                [-8.725204467773438, 40.66117324360654],
                [-8.72288703918457, 40.66826975856376],
                [-8.716878890991211, 40.675495708799446],
                [-8.715934753417969, 40.68363210267408],
                [-8.717050552368164, 40.692548449646836],
                [-8.714303970336914, 40.702569780377935],
                [-8.707437515258789, 40.71102817184792],
                [-8.696279525756834, 40.71642796756138],
                [-8.681774139404297, 40.72104672237615],
                [-8.667354583740234, 40.72481955186487],
                [-8.652763366699219, 40.727291289709356],
            ];



            var nivel_mare = [
                [3],
                [2.94375],
                [2.8875],
                [2.83125],
                [2.775],
                [2.6625],
                [2.55],
                [2.4375],
                [2.325],
                [2.15625],
                [1.9875],
                [1.81875],
                [1.65],
                [1.48125],
                [1.31],
                [1.14],
            ];

            var nivel_ZRotaAdquirida = [
                [3.5],
                [3.30],
                [3.4],
                [3.4],
                [3.70],
                [4],
                [4.5],
                [3],
                [3.4],
                [4],
                [3.9],
                [3.20],
                [3.0],
                [3.4],
                [3.5],
                [3],
            ];

            // var nivel_mareNOVA = [
            //     [0.41],
            //     [0.3],
            //     [0.36],
            //     [0.41],
            //     [0.53],
            //     [0.6375],
            //     [0.75],
            //     [0.8625],
            //     [0.975],
            //     [1.14375],
            //     [1.3125],
            //     [1.48125],
            //     [1.65],
            //     [1.82],
            //     [1.99],
            //     [2.16],
            // ];

            let distancia;
            let arDistan = [];
            let countdangerous=0;
            let warning = 0;
            for (var i = 0; i < coordenadas.length; i++) {
                //diferençaAlturaMare = nivel_mare[i][0] - nivel_mareNOVA[i][0];
                diferençaAlturaMare = nivel_mare[i][0] - arRetirMare[i];
                ZNOvaRota = nivel_ZRotaAdquirida[i][0] - diferençaAlturaMare;
                verificarRota = ZNOvaRota - calado;
                //console.log(verificarRota)
                if (verificarRota < margemcaladoInf) {
                    if (coordenadas[i + 1] != undefined) {
                        //console.log('vermelho' + verificarRota)
                        var myLines1 = [{
                            "type": "LineString",
                            'coordinates': [
                                [coordenadas[i][0], coordenadas[i][1]],
                                [coordenadas[i + 1][0], coordenadas[i + 1][1]],
                            ]
                        }];
                        distancia = mymap.distance([coordenadas[i][0], coordenadas[i][1]], [coordenadas[i + 1][0], coordenadas[i + 1][1]]);
                        arDistan.push(distancia.toFixed(2));
                        var myStyle1 = {
                            radius: 8,
                            color: "red",
                            weight: 5,
                            opacity: 1,
                        };

                        linesFeatureLayer = L.geoJson(myLines1, {
                            style: myStyle1
                        });
                        linesFeatureLayer.addTo(mymap);
                        countdangerous++;
                    } else {
                        //console.log('')
                    }
                } else if (verificarRota >= margemcaladoInf && verificarRota <= margemcaladoSup) {

                    if (coordenadas[i + 1] != undefined) {
                        //console.log('amarelo' + verificarRota)
                        var myLines2 = [{
                            "type": "LineString",
                            'coordinates': [
                                [coordenadas[i][0], coordenadas[i][1]],
                                [coordenadas[i + 1][0], coordenadas[i + 1][1]],
                            ]
                        }];
                        distancia = mymap.distance([coordenadas[i][0], coordenadas[i][1]], [coordenadas[i + 1][0], coordenadas[i + 1][1]]);
                        arDistan.push(distancia.toFixed(2));
                        var myStyle2 = {
                            radius: 8,
                            color: "yellow",
                            weight: 5,
                            opacity: 1,
                        };

                        linesFeatureLayer2 = L.geoJson(myLines2, {
                            style: myStyle2
                        });
                        linesFeatureLayer2.addTo(mymap);
                        warning++;

                    } else {
                        console.log('')
                    }
                } else if (verificarRota >= margemcaladoSup) {

                    if (coordenadas[i + 1] != undefined) {
                        //console.log('verde' + verificarRota)
                        var myLines3 = [{
                            "type": "LineString",
                            'coordinates': [
                                [coordenadas[i][0], coordenadas[i][1]],
                                [coordenadas[i + 1][0], coordenadas[i + 1][1]],
                            ]
                        }];
                        distancia = mymap.distance([coordenadas[i][0], coordenadas[i][1]], [coordenadas[i + 1][0], coordenadas[i + 1][1]]);
                        arDistan.push(distancia.toFixed(2));

                        var myStyle3 = {
                            radius: 8,
                            color: "green",
                            weight: 5,
                            opacity: 1,
                        };

                        linesFeatureLayer3 = L.geoJson(myLines3, {
                            style: myStyle3
                        });
                        linesFeatureLayer3.addTo(mymap);
                        if(countdangerous<warning){
                            popup = L.popup()
                            .setLatLng([coordenadas[i][1], coordenadas[i][0]])
                            .setContent('<p>Pode encanlhar em alguns pontos</p>')
                            .openOn(mymap);
                        }else if(warning>0){
                            popup = L.popup()
                            .setLatLng([coordenadas[i][1], coordenadas[i][0]])
                            .setContent('<p>Possibilidade de encanlhar</p>')
                            .openOn(mymap);
                        }else if(countdangerous>0){
                            popup = L.popup()
                            .setLatLng([coordenadas[i][1], coordenadas[i][0]])
                            .setContent('<p>Pode encanlhar em alguns pontos</p>')
                            .openOn(mymap);
                        }else{
                            popup = L.popup()
                            .setLatLng([coordenadas[i][1], coordenadas[i][0]])
                            .setContent('<p>Pode viajar com segurança</p>')
                            .openOn(mymap);
                        }
                        
                    } else {

                    }
                }

            }


            let sum = 0;
            for (let u = 0; u < arDistan.length; u++) {
                sum += parseFloat(arDistan[u]);

            }
            let newsum = sum/ 1000;
            document.getElementById('km').innerHTML = "<p>"+newsum.toFixed(2)+ " KM </p>";

        }





        function clearmap() {

            mymap.eachLayer(function (layer) {
                //console.log(layer.options.pane)
                if (layer.options.pane == "overlayPane") {
                    mymap.removeLayer(layer);
                }
            });

            document.getElementById('calado_span').value = "";
            document.getElementById('calado_sup_span').value = "";
            document.getElementById('calado_inf_span').value = "";
            document.getElementById('time').value = 0;
        }
    </script>

</body>

</html>